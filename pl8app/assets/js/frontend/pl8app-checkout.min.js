window.pl8app_Checkout=function($){"use strict";var $body,$form,$pl8app_cart_amount,$checkout_form_wrap;function apply_discount(event){event.preventDefault();$(this);var discount_code=$("#pl8app-discount").val(),pl8app_discount_loader=$("#pl8app-discount-loader");if(""==discount_code||discount_code==pl8app_global_vars.enter_discount)return!1;var postData={action:"pl8app_apply_discount",code:discount_code,form:$("#pl8app_purchase_form").serialize()};return $("#pl8app-discount-error-wrap").html("").hide(),pl8app_discount_loader.show(),$.ajax({type:"POST",data:postData,dataType:"json",url:pl8app_global_vars.ajaxurl,xhrFields:{withCredentials:!0},success:function(discount_response){if(discount_response)if("valid"==discount_response.msg){$(".pl8app_cart_discount").html(discount_response.html),$(".pl8app_cart_discount_row").show(),$(".pl8app_cart_amount").each(function(){$(this).text(discount_response.total),$(this).data("total",discount_response.total_plain)}),$("#pl8app-discount",$checkout_form_wrap).val(""),recalculate_taxes();var inputs=$("#pl8app_cc_fields .pl8app-input, #pl8app_cc_fields .pl8app-select,#pl8app_cc_address .pl8app-input, #pl8app_cc_address .pl8app-select,#pl8app_payment_mode_select .pl8app-input, #pl8app_payment_mode_select .pl8app-select");"0.00"==discount_response.total_plain?($("#pl8app_cc_fields,#pl8app_cc_address,#pl8app_payment_mode_select").slideUp(),inputs.removeAttr("required"),$('input[name="pl8app-gateway"]').val("manual")):(inputs.is(".card-address-2")||inputs.attr("required","required"),$("#pl8app_cc_fields,#pl8app_cc_address").slideDown()),$body.trigger("pl8app_discount_applied",[discount_response])}else $("#pl8app-discount-error-wrap").html('<span class="pl8app_error">'+discount_response.msg+"</span>"),$("#pl8app-discount-error-wrap").show(),$body.trigger("pl8app_discount_invalid",[discount_response]);else window.console&&window.console.log&&console.log(discount_response),$body.trigger("pl8app_discount_failed",[discount_response]);pl8app_discount_loader.hide()}}).fail(function(data){window.console&&window.console.log&&console.log(data)}),!1}function remove_discount(event){var postData={action:"pl8app_remove_discount",code:$(this).data("code")};return $.ajax({type:"POST",data:postData,dataType:"json",url:pl8app_global_vars.ajaxurl,xhrFields:{withCredentials:!0},success:function(discount_response){var zero="0"+pl8app_global_vars.decimal_separator+"00";$(".pl8app_cart_amount").each(function(){pl8app_global_vars.currency_sign+zero!=$(this).text()&&zero+pl8app_global_vars.currency_sign!=$(this).text()||window.location.reload(),$(this).text(discount_response.total),$(this).data("total",discount_response.total_plain)}),$(".pl8app_cart_discount").html(discount_response.html),discount_response.discounts||$(".pl8app_cart_discount_row").hide(),recalculate_taxes(),$("#pl8app_cc_fields,#pl8app_cc_address").slideDown(),$body.trigger("pl8app_discount_removed",[discount_response])}}).fail(function(data){window.console&&window.console.log&&console.log(data)}),!1}function update_item_quantities(event){var $this=$(this),quantity=$this.val(),key=$this.data("key"),menuitem_id=$this.closest(".pl8app_cart_item").data("menuitem-id"),options=$this.parent().find('input[name="pl8app-cart-menuitem-'+key+'-options"]').val(),pl8app_cc_address=$("#pl8app_cc_address"),postData={action:"pl8app_update_quantity",quantity:quantity,menuitem_id:menuitem_id,options:options,billing_country:pl8app_cc_address.find("#billing_country").val(),card_state:pl8app_cc_address.find("#card_state").val()};return $.ajax({type:"POST",data:postData,dataType:"json",url:pl8app_global_vars.ajaxurl,xhrFields:{withCredentials:!0},success:function(response){$(".pl8app_cart_subtotal_amount").each(function(){$(this).text(response.subtotal)}),$(".pl8app_cart_tax_amount").each(function(){$(this).text(response.taxes)}),$(".pl8app_cart_amount").each(function(){$(this).text(response.total),$body.trigger("pl8app_quantity_updated",[response])})}}).fail(function(data){window.console&&window.console.log&&console.log(data)}),!1}return{init:function(){$body=$(document.body),$form=$("#pl8app_purchase_form"),$pl8app_cart_amount=$(".pl8app_cart_amount"),$pl8app_cart_amount.text(),$checkout_form_wrap=$("#pl8app_checkout_form_wrap"),$body.on("pl8app_gateway_loaded",function(e){var form,card_number,card_cvc,card_expiry;card_number=(form=$form).find(".card-number"),card_cvc=form.find(".card-cvc"),card_expiry=form.find(".card-expiry"),card_number.length&&"function"==typeof card_number.payment&&(card_number.payment("formatCardNumber"),card_cvc.payment("formatCardCVC"),card_expiry.payment("formatCardExpiry"))}),$body.on("keyup change",".pl8app-do-validate .card-number",function(){var field,card_field;field=$(this),(card_field=field).validateCreditCard(function(result){var $card_type=$(".card-type");null==result.card_type?($card_type.removeClass().addClass("off card-type"),card_field.removeClass("valid"),card_field.addClass("error")):($card_type.removeClass("off"),$card_type.addClass(result.card_type.name),result.length_valid&&result.luhn_valid?(card_field.addClass("valid"),card_field.removeClass("error")):(card_field.removeClass("valid"),card_field.addClass("error")))})}),$body.on("blur change",".card-name",function(){var name_field=$(this);name_field.validateCreditCard(function(result){null!=result.card_type?(name_field.removeClass("valid").addClass("error"),$("#pl8app-purchase-button").attr("disabled","disabled")):(name_field.removeClass("error").addClass("valid"),$("#pl8app-purchase-button").removeAttr("disabled"))})}),$body.on("submit","#pl8app_payment_mode",function(){if(0==$("#pl8app-gateway option:selected").val())return alert(pl8app_global_vars.no_gateway),!1}),$body.on("click","#pl8app_payment_mode_select input",function(){$("#pl8app_payment_mode_select label.pl8app-gateway-option-selected").removeClass("pl8app-gateway-option-selected"),$("#pl8app_payment_mode_select input:checked").parent().addClass("pl8app-gateway-option-selected")}),$checkout_form_wrap.on("click",".pl8app-apply-discount",apply_discount),$checkout_form_wrap.on("keypress","#pl8app-discount",function(event){if("13"==event.keyCode)return!1}),$checkout_form_wrap.on("keyup","#pl8app-discount",function(event){"13"==event.keyCode&&$checkout_form_wrap.find(".pl8app-apply-discount").trigger("click")}),$body.on("click",".pl8app_discount_remove",remove_discount),$body.on("click",".pl8app_discount_link",function(e){e.preventDefault(),$(".pl8app_discount_link").parent().hide(),$("#pl8app-discount-code-wrap").show().find("#pl8app-discount").focus()}),$body.find("#pl8app-discount-code-wrap").hide(),$body.find("#pl8app_show_discount").show(),$body.on("change",".pl8app-item-quantity",update_item_quantities),$body.on("click",".pl8app-amazon-logout #Logout",function(e){e.preventDefault(),amazon.Login.logout(),window.location=pl8app_amazon.checkoutUri})},recalculate_taxes:recalculate_taxes}}(window.jQuery),window.jQuery(document).ready(pl8app_Checkout.init);var ajax_tax_count=0;function recalculate_taxes(state){if("1"==pl8app_global_vars.taxes_enabled){var $pl8app_cc_address=jQuery("#pl8app_cc_address");state||(state=$pl8app_cc_address.find("#card_state").val());var postData={action:"pl8app_recalculate_taxes",billing_country:$pl8app_cc_address.find("#billing_country").val(),state:state,card_zip:$pl8app_cc_address.find("input[name=card_zip]").val()},current_ajax_count=++ajax_tax_count;jQuery.ajax({type:"POST",data:postData,dataType:"json",url:pl8app_global_vars.ajaxurl,xhrFields:{withCredentials:!0},success:function(tax_response){if(current_ajax_count===ajax_tax_count){jQuery("#pl8app_checkout_cart_form").replaceWith(tax_response.html),jQuery(".pl8app_cart_amount").html(tax_response.total);var tax_data=new Object;tax_data.postdata=postData,tax_data.response=tax_response,jQuery("body").trigger("pl8app_taxes_recalculated",[tax_data])}}}).fail(function(data){window.console&&window.console.log&&(console.log(data),current_ajax_count===ajax_tax_count&&jQuery("body").trigger("pl8app_taxes_recalculated",[tax_data]))})}}